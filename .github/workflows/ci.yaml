name: Build & Push Images

on:
  push:
    branches:
      - main
      - release/**
      - feature/**
      - hotfix/**
  workflow_dispatch:

jobs:
  # ----------------------------------------------------
  # 1. Always-visible job (proves CI triggered)
  # ----------------------------------------------------
  ci-started:
    runs-on: ubuntu-latest
    steps:
      - run: echo "CI triggered successfully"

  # ----------------------------------------------------
  # 2. Detect environment from branch
  # ----------------------------------------------------
  detect-env:
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.set-env.outputs.env }}
    steps:
      - id: set-env
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"

          if [[ "$BRANCH" == "main" ]]; then
            echo "env=prod" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == release/* ]]; then
            echo "env=qa" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == hotfix/* ]]; then
            echo "env=prod" >> $GITHUB_OUTPUT
          else
            echo "env=dev" >> $GITHUB_OUTPUT
          fi

  # ----------------------------------------------------
  # 3. Detect which services changed
  # ----------------------------------------------------
  detect-changes:
    runs-on: ubuntu-latest
    needs: detect-env
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      wallet: ${{ steps.filter.outputs.wallet }}
      transactions: ${{ steps.filter.outputs.transactions }}
    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - digital-wallet-demo/frontend/**
            wallet:
              - digital-wallet-demo/services/wallets/**
            transactions:
              - digital-wallet-demo/services/transactions/**

      # Debug output (VERY IMPORTANT)
      - name: Debug path filter outputs
        run: |
          echo "frontend=${{ steps.filter.outputs.frontend }}"
          echo "wallet=${{ steps.filter.outputs.wallet }}"
          echo "transactions=${{ steps.filter.outputs.transactions }}"

  # ----------------------------------------------------
  # 4. Build & push images
  # ----------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    needs: [detect-env, detect-changes]
    strategy:
      matrix:
        service: [frontend, wallet, transactions]

    # ðŸ”¥ SAFE, SINGLE-LINE IF (NO YAML ISSUES)
    if: ${{ github.ref != 'refs/heads/main' || ( (matrix.service == 'frontend' && needs.detect-changes.outputs.frontend == 'true') || (matrix.service == 'wallet' && needs.detect-changes.outputs.wallet == 'true') || (matrix.service == 'transactions' && needs.detect-changes.outputs.transactions == 'true') ) }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to private registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login \
            "${{ secrets.REGISTRY_URL }}" \
            -u "${{ secrets.REGISTRY_USER }}" \
            --password-stdin

      - name: Build & push image
        run: |
          ENV="${{ needs.detect-env.outputs.env }}"
          SHA="${GITHUB_SHA::7}"

          if [[ "${{ matrix.service }}" == "frontend" ]]; then
            CONTEXT="digital-wallet-demo/frontend"
          elif [[ "${{ matrix.service }}" == "wallet" ]]; then
            CONTEXT="digital-wallet-demo/services/wallets"
          else
            CONTEXT="digital-wallet-demo/services/transactions"
          fi

          IMAGE="${{ secrets.REGISTRY_URL }}/digital-wallet/${{ matrix.service }}:${ENV}-${SHA}"

          echo "Building $IMAGE from $CONTEXT"
          docker build -t "$IMAGE" "$CONTEXT"
          docker push "$IMAGE"

name: CI DIAGNOSTIC

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  ci-started:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "CI TRIGGERED"
          echo "REF=$GITHUB_REF"
          echo "EVENT=$GITHUB_EVENT_NAME"

  detect-env:
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.env.outputs.env }}
    steps:
      - id: env
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"

          if [[ "$BRANCH" == "main" ]]; then
            ENV=prod
          elif [[ "$BRANCH" == release/* ]]; then
            ENV=qa
          elif [[ "$BRANCH" == hotfix/* ]]; then
            ENV=prod
          else
            ENV=dev
          fi

          echo "Detected ENV=$ENV"
          echo "env=$ENV" >> $GITHUB_OUTPUT

  show-env:
    runs-on: ubuntu-latest
    needs: detect-env
    steps:
      - run: echo "ENV FROM PREVIOUS JOB = ${{ needs.detect-env.outputs.env }}"


  detect-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - digital-wallet-demo/frontend/**
            wallet:
              - digital-wallet-demo/services/wallets/**
            transactions:
              - digital-wallet-demo/services/transactions/**

      - run: |
          echo "frontend=${{ steps.filter.outputs.frontend }}"
          echo "wallet=${{ steps.filter.outputs.wallet }}"
          echo "transactions=${{ steps.filter.outputs.transactions }}"